---
title: "advds4bme Final Project"
author: "Adam Kenet and Karl Lee"
date: "4/2021"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r}
# Advanced Data Science for BME
# Adam Kenet and Karl Lee
# April 2021
# Final Project
```


```{r setup, echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
library(flexdashboard)
library(tidyverse)
library(dplyr)
library(plotly)
library(shiny)
library(lubridate)
library(googleVis)
library(leaflet)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
root = "C:/Users/adamk/Desktop/Flight Delay Predictor"
setwd(paste0(root,"/flight_delay_predictor"))

# import individual data files
dat0 <- read_csv('https://raw.githubusercontent.com/akenet/flight_delay_predictor/main/Data/flights0.csv')
dat1 <- read_csv('https://raw.githubusercontent.com/akenet/flight_delay_predictor/main/Data/flights1.csv', col_names = FALSE) %>% 
  rename('FL_DATE' = 'X1',
         'OP_CARRIER' = 'X2',
         'ORIGIN' = 'X3',
         'DEST' = 'X4',
         'CRS_DEP_TIME' = 'X5',
         'DEP_DELAY' = 'X6')

# combine individual data files
dat <- rbind(dat0, dat1) %>%
  rename('DATE' = 'FL_DATE',
         'AIRLINE' = 'OP_CARRIER',
         'DEPARTURE' = 'ORIGIN',
         'ARRIVAL' = 'DEST',
         'DEP_TIME' = 'CRS_DEP_TIME')

# remove individual data files
rm(dat0, dat1)
```

```{r}
# import data from CCSE Github
cases_raw <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
deaths_raw <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
recovered_raw <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")

# countries to chose from
countries <- sort(c("Germany", "Italy", "Japan", "Brazil", "Uganda", "Russia", "Ecuador", "Oman", "Mexico", "Finland", "Vietnam"))

# create df for map plot
lat_long <- cases_raw %>% filter(Country.Region %in% countries) %>% subset(select = c(Country.Region, Lat, Long)) 

cur_cases <- cases_raw %>% filter(Country.Region %in% countries) %>% subset(select = c(ncol(cases_raw)))
cur_deaths <- deaths_raw %>% filter(Country.Region %in% countries) %>% subset(select = c(ncol(deaths_raw)))
cur_recovered <- recovered_raw %>% filter(Country.Region %in% countries) %>% subset(select = c(ncol(recovered_raw)))

lat_long <- cbind(lat_long, cur_cases, cur_deaths, cur_recovered)

colnames(lat_long) <- c("Country", "Lat", "Long", "Current Cases", "Current Deaths", "Current Recovered")


# filter data to only include countries of interest
cases_linear <- cases_raw %>%
  filter(Country.Region %in% countries) %>% 
  subset(select = -c(Province.State))

deaths_linear <- deaths_raw %>%
  filter(Country.Region %in% countries) %>% 
  subset(select = -c(Province.State))

recovered_linear <- recovered_raw %>%
  filter(Country.Region %in% countries) %>% 
  subset(select = -c(Province.State))

# change name of Country.Region column
colnames(cases_linear)[1] <- "Country"
colnames(deaths_linear)[1] <- "Country"
colnames(recovered_linear)[1] <- "Country"


# reformat data to make it tidy
cases_linear <- pivot_longer(cases_linear, !c(Country, Lat, Long), names_to = "Date", values_to = "Value")
deaths_linear <- pivot_longer(deaths_linear, !c(Country, Lat, Long), names_to = "Date", values_to = "Value")
recovered_linear <- pivot_longer(recovered_linear, !c(Country, Lat, Long), names_to = "Date", values_to = "Value")

# fix date names
cases_linear$Date <- sub('^.', '', cases_linear$Date)
deaths_linear$Date <- sub('^.', '', deaths_linear$Date)
recovered_linear$Date <- sub('^.', '', recovered_linear$Date)

# convert dates from chr to time
cases_linear$Date <- mdy(cases_linear$Date)
deaths_linear$Date <- mdy(deaths_linear$Date)
recovered_linear$Date <- mdy(recovered_linear$Date)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
airport_data <- read_csv('https://raw.githubusercontent.com/akenet/flight_delay_predictor/main/airports_filtered.csv')

airport_data <- airport_data %>% mutate(full = paste0(airport_data$NAME, ' (', airport_data$IATA, ')'))

airport_data <- airport_data[order(airport_data$full),]

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
airlines = sort(unique(dat$AIRLINE))
airports = sort(unique(airport_data$full))




```


Column {.sidebar data-width=400}
-----------------------------------------------------------------------

### Your Flight:
```{r}
hr()
# which airline
selectInput(inputId = "airline", label = "Airline:",
            choices = airlines,
            selected = 'American Airlines')

# which departure airport
selectInput(inputId = "departure", label = "Departure Airport:",
            choices = airports,
            selected = 'LaGuardia Airport (LGA)')

# which arrival airport
selectInput(inputId = "arrival", label = "Arrival Airport:",
            choices = airports,
            selected = 'Los Angeles International Airport (LAX)')

# which departure date
dateInput(inputId = "date", label = "Departure Date:",
          value = "2021-05-01")



# which start
selectInput(inputId = "start", label = "Choose when to start plot:",
            choices = c('show all data', 'show from first day of data'),
            selected = 'show all data')

# which scales
selectInput(inputId = "scale", label = "Choose a scale:",
            choices = c('log', 'linear'),
            selected = 'log')

# smoothed line
radioButtons(inputId = "smooth", label = "Do you want to show a smoothed line?",
             choices = list("Yes", "No"),
             selected = "No")

```

Columnn {data-width=550}
-----------------------------------------------------------------------

#### COVID-19 Case Tracker
```{r}
renderPlotly({
  
  # Determine which type of data was chosen
  whichData <- switch(input$data,
                'cases'=cases_linear,
                'deaths'=deaths_linear,
                'recovered'=recovered_linear
  )
  # change y-axis for each type of data
  y_label <- switch(input$data,
                      'cases'='Cases',
                      'deaths'='Deaths',
                      'recovered'='Recovered'
  )
  # what type of data was chosen (for x-axis label)
  type <- switch(input$data,
                 'cases'='Case',
                 'deaths'='Death',
                 'recovered'='Recovered'
  )

  # Determine which countries were chosen
  whichCountries <- filter(whichData, Country %in% input$country)


  # Determine which scale was chosen
  whichScale <- switch(input$scale,
                       'linear'=whichCountries,
                       'log'=data.frame(Country = whichCountries$Country,
                                        Date = whichCountries$Date,
                                        Value = log(whichCountries$Value))
  )
  # change y-axis label for log scale
  if(input$scale=='log'){
    y_label <- paste(y_label,'(log)')
  }


  # Determine when to start plot
  whichStart <- switch(input$start,
                       'show all data'=whichScale,
                       'show from first day of data'={
                         # so not overwriting data
                         dummy_data <- whichScale %>% group_by(Country)

                         # convert dates to day number
                         dummy_data$Date <- as.integer(dummy_data$Date - min(dummy_data$Date))

                         # remove days with no cases
                         dummy_data <- filter(dummy_data, Value>0)

                         # create column of start dates
                         start_dates <- summarise(dummy_data, rep(min(Date),length(Date)))

                         # subtract start date
                         dummy_data$Date <- dummy_data$Date - start_dates$`rep(min(Date), length(Date))`

                         dummy_data
                       }
  )
  # change x-axis label
  if(input$start=='show from first day of data'){
    x_label <- paste('Day Since First',type)
  }
  else{
    x_label <- 'Date'
  }

  # final data for plotting
  dat2plot <- whichStart
  
  # set up theme
  my_theme <- theme_classic() +
    theme(text = element_text(size = 14),
          plot.title = element_text(hjust = 0.5),
          axis.title.x = element_text(margin = margin(10,0,0,0)),
          axis.title.y = element_text(margin = margin(0,10,0,0)),
          axis.text.x = element_text(margin = margin(5,0,0,0)),
          axis.text.y = element_text(margin = margin(0,5,0,0)))
  
  # create base plot
  basePlot <- ggplot(dat2plot, aes(x=Date, y=Value, color = Country)) +
    geom_line() +
    scale_y_continuous(name = y_label) +
    my_theme
  
  # fix x-axis labels for plot
  if(input$start=='show from first day of data'){
    basePlot2 <- basePlot +
      scale_x_continuous(name = paste('Days Since First',type))
  }
  else{
    basePlot2 <- basePlot
  }
  
  # add smoothed line
  if(input$smooth=='Yes'){
    myPlot <- basePlot2 + geom_smooth(se=FALSE)
  }
  else{
    myPlot <- basePlot2
  }
  
  
  # make interactive
  plotly_build(myPlot)
})
```

#### Airports
```{r}

renderLeaflet({
# filter chosen airports
lat_long <- filter(airport_data, (airports %in% input$departure) | (airports %in% input$arrival))

# create plot
lat_long %>%
  leaflet() %>%
  addTiles() %>%
  addMarkers(lat = ~LAT,
             lng = ~LONG,
             popup = paste("<strong>",lat_long$full)) %>% 
  addCircles(lat = ~LAT,
             lng = ~LONG,
             weight = 1)
})

```