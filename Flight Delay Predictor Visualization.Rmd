---
title: "advds4bme Final Project"
author: "Adam Kenet and Karl Lee"
date: "4/2021"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r}
# Advanced Data Science for BME
# Adam Kenet and Karl Lee
# April 2021
# Final Project
```


```{r setup, echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
library(flexdashboard)
library(tidyverse)
library(dplyr)
library(plotly)
library(shiny)
library(lubridate)
library(googleVis)
library(leaflet)
library(geosphere)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
root = "C:/Users/adamk/Desktop/Flight Delay Predictor"
setwd(paste0(root,"/flight_delay_predictor"))

# import individual data files
dat0 <- read_csv('https://raw.githubusercontent.com/akenet/flight_delay_predictor/main/Data/flights0.csv')
dat1 <- read_csv('https://raw.githubusercontent.com/akenet/flight_delay_predictor/main/Data/flights1.csv', col_names = FALSE) %>% 
  rename('FL_DATE' = 'X1',
         'OP_CARRIER' = 'X2',
         'ORIGIN' = 'X3',
         'DEST' = 'X4',
         'CRS_DEP_TIME' = 'X5',
         'DEP_DELAY' = 'X6')

# combine individual data files
dat <- rbind(dat0, dat1) %>%
  rename('DATE' = 'FL_DATE',
         'AIRLINE' = 'OP_CARRIER',
         'DEPARTURE' = 'ORIGIN',
         'ARRIVAL' = 'DEST',
         'DEP_TIME' = 'CRS_DEP_TIME')

# remove individual data files
rm(dat0, dat1)

# remove year from dates
dat <- mutate(dat, DATE=format(as.Date(DATE), "%m-%d"))

# convert date from chr to date
dat$DATE <- as.Date(dat$DATE, format = "%m-%d")
```

```{r}
########## OLD DATA/CODE JUST AS PLACEHOLDER FOR FLEXDASHBOARD #################


# import data from CCSE Github
cases_raw <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
deaths_raw <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
recovered_raw <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")

# countries to chose from
countries <- sort(c("Germany", "Italy", "Japan", "Brazil", "Uganda", "Russia", "Ecuador", "Oman", "Mexico", "Finland", "Vietnam"))

# create df for map plot
lat_long <- cases_raw %>% filter(Country.Region %in% countries) %>% subset(select = c(Country.Region, Lat, Long)) 

cur_cases <- cases_raw %>% filter(Country.Region %in% countries) %>% subset(select = c(ncol(cases_raw)))
cur_deaths <- deaths_raw %>% filter(Country.Region %in% countries) %>% subset(select = c(ncol(deaths_raw)))
cur_recovered <- recovered_raw %>% filter(Country.Region %in% countries) %>% subset(select = c(ncol(recovered_raw)))

lat_long <- cbind(lat_long, cur_cases, cur_deaths, cur_recovered)

colnames(lat_long) <- c("Country", "Lat", "Long", "Current Cases", "Current Deaths", "Current Recovered")


# filter data to only include countries of interest
cases_linear <- cases_raw %>%
  filter(Country.Region %in% countries) %>% 
  subset(select = -c(Province.State))

deaths_linear <- deaths_raw %>%
  filter(Country.Region %in% countries) %>% 
  subset(select = -c(Province.State))

recovered_linear <- recovered_raw %>%
  filter(Country.Region %in% countries) %>% 
  subset(select = -c(Province.State))

# change name of Country.Region column
colnames(cases_linear)[1] <- "Country"
colnames(deaths_linear)[1] <- "Country"
colnames(recovered_linear)[1] <- "Country"


# reformat data to make it tidy
cases_linear <- pivot_longer(cases_linear, !c(Country, Lat, Long), names_to = "Date", values_to = "Value")
deaths_linear <- pivot_longer(deaths_linear, !c(Country, Lat, Long), names_to = "Date", values_to = "Value")
recovered_linear <- pivot_longer(recovered_linear, !c(Country, Lat, Long), names_to = "Date", values_to = "Value")

# fix date names
cases_linear$Date <- sub('^.', '', cases_linear$Date)
deaths_linear$Date <- sub('^.', '', deaths_linear$Date)
recovered_linear$Date <- sub('^.', '', recovered_linear$Date)

# convert dates from chr to time
cases_linear$Date <- mdy(cases_linear$Date)
deaths_linear$Date <- mdy(deaths_linear$Date)
recovered_linear$Date <- mdy(recovered_linear$Date)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# import data on airports in data
airport_data <- read_csv('https://raw.githubusercontent.com/akenet/flight_delay_predictor/main/airports_filtered.csv')

# add column that includes name and IATA code together
airport_data <- airport_data %>% mutate(full = paste0(airport_data$NAME, ' (', airport_data$IATA, ')'))

# alphabetize the data by airport name
airport_data <- airport_data[order(airport_data$full),]
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# create unique lists
airlines = sort(unique(dat$AIRLINE))
airports = sort(unique(airport_data$full))

arrivals = sort(unique(dat$ARRIVAL))
departures = sort(unique(dat$DEPARTURE))
```


Column {.sidebar data-width=400}
-----------------------------------------------------------------------

### Your Flight:
```{r}
hr()
# which airline
selectInput(inputId = "airline", label = "Airline:",
            choices = airlines,
            selected = 'American Airlines')

# which departure airport
selectInput(inputId = "departure", label = "Departure Airport:",
            choices = airports,
            selected = 'LaGuardia Airport (LGA)')

# which arrival airport
selectInput(inputId = "arrival", label = "Arrival Airport:",
            choices = airports,
            selected = 'Los Angeles International Airport (LAX)')

# which departure date
dateInput(inputId = "date", label = "Departure Date:",
          value = NULL,
          format = "mm-dd")
```

Column {data-width=550}
-----------------------------------------------------------------------

#### Historical Delays For Your Flight
```{r}
renderPlotly({
  
  # Filter by airline
  whichAirline <- filter(dat, AIRLINE == input$airline)
  
  # Determine which departure airport was chosen
  dep <- input$departure
  dep <- substr(dep, nchar(dep)-3, nchar(dep)-1) # get only the IATA code
  
  # check to make sure there is data
  num_data1 <- sum(whichAirline$DEPARTURE == dep)
  
  good = 0
  if (num_data1 > 0){ # if there is data from departure airport
    # Filter by departure airport
    whichDeparture <- filter(whichAirline, DEPARTURE == dep)
    good = 1
    
    # Determine which arrival airport was chosen
    arr <- input$arrival
    arr <- substr(arr, nchar(arr)-3, nchar(arr)-1) # get only the IATA code
    
    # check to make sure there is data
    num_data2 <- sum(whichDeparture$ARRIVAL == arr)
    
    if (num_data2 > 0){ # if there is data from arrival airport
      # Filter by arrival airport
      whichArrival <- filter(whichDeparture, ARRIVAL == arr)
      good = good + 1 # good=2 if have date from both departure and arrival airport
    }
    
  }
  
  # # Determine which date was chosen
  # dateFilter
  # whichDate <- filter(whichData, Country %in% input$country)
  
  if (good == 2) { # if have data from both departure and arrival airport
    # final data for plotting
    dat2plot <- whichArrival
    
    # set up theme
    my_theme <- theme_classic() +
      theme(text = element_text(size = 14),
            plot.title = element_text(hjust = 0.5),
            axis.title.x = element_text(margin = margin(10,0,0,0)),
            axis.title.y = element_text(margin = margin(0,10,0,0)),
            axis.text.x = element_text(margin = margin(5,0,0,0)),
            axis.text.y = element_text(margin = margin(0,5,0,0)))
    
    # create base plot
    myPlot <- ggplot(dat2plot, aes(x=DATE, y=DEP_DELAY)) +
      geom_point() +
      scale_x_date(date_breaks = "1 month",
                   date_labels = "%m-%d") +
      xlab('Delay (min)') +
      ylab('Departure Date') +
      my_theme
  } else { # if don't have data from departure/arrival/both airports
    myPlot <- ggplot() +
      annotate("text", x = 4, y = 25, size = 8, label='No Data Available') +
      theme_void()
  }
  
  # make interactive
  plotly_build(myPlot)
  
})
```

#### Airports
```{r}

renderLeaflet({
  # filter chosen airports
  lat_long <- filter(airport_data, (airports %in% input$departure) | (airports %in% input$arrival))
  
  arr_lat_long <- filter(airport_data, airports %in% input$arrival)
  dep_lat_long <- filter(airport_data, airports %in% input$departure)
  
  gcIntermediate(c(dep_lat_long$LONG, dep_lat_long$LAT), c(arr_lat_long$LONG, arr_lat_long$LAT), n=100, addStartEnd = TRUE, sp = TRUE) %>%
    leaflet() %>%
    addTiles() %>%
    addMarkers(lat = lat_long$LAT,
               lng = lat_long$LONG,
               popup = paste("<strong>",lat_long$full)) %>%
    addCircles(lat = lat_long$LAT,
               lng = lat_long$LONG,
               weight = 1) %>%
    addPolylines()
})

```